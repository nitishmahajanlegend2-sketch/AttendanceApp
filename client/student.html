<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Student Attendance Portal</title>
</head>
<body class="bg-slate-100 p-6 flex items-center justify-center min-h-screen">

    <div class="max-w-md w-full bg-white p-8 rounded-3xl shadow-2xl">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-extrabold text-slate-800">Attendance Form</h2>
            <p class="text-slate-500 mt-2">B.TECH CSE - Section B</p>
        </div>

        <form id="attendanceForm" class="space-y-5">
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Full Name</label>
                <input 
                    type="text" 
                    id="sName" 
                    required 
                    placeholder="Name As per College Records" 
                    class="w-full p-4 border-2 border-slate-100 rounded-2xl focus:border-blue-500 focus:ring-4 focus:ring-blue-50 focus:outline-none transition-all"
                />
            </div>

            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Roll Number</label>
                <input 
                    type="text" 
                    id="sRoll" 
                    required 
                    placeholder="e.g. 17032500..." 
                    class="w-full p-4 border-2 border-slate-100 rounded-2xl focus:border-blue-500 focus:ring-4 focus:ring-blue-50 focus:outline-none transition-all"
                />
            </div>

            <button 
                type="submit" 
                id="submitBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-100 active:scale-95 transition-all"
            >
                Submit Attendance
            </button>
        </form>

        <div id="msgBox" class="hidden mt-6 p-4 rounded-2xl text-center font-bold border-2">
            <p id="msg"></p>
        </div>
    </div>

    <script>
        // 1. Manage Unique Device ID (Prevents multiple students from using one phone)
        let userId = localStorage.getItem('attendance_uid');
        if (!userId) {
            userId = 'STU-' + Math.random().toString(36).substr(2, 9) + Date.now();
            localStorage.setItem('attendance_uid', userId);
        }

        const form = document.getElementById('attendanceForm');
        const submitBtn = document.getElementById('submitBtn');
        const msgBox = document.getElementById('msgBox');
        const msgText = document.getElementById('msg');

        // 2. Handle Form Submission
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Stop page refresh
            
            // Disable button to prevent double-clicks
            submitBtn.innerText = "Processing...";
            submitBtn.disabled = true;

            const name = document.getElementById('sName').value.trim();
            const rollNo = document.getElementById('sRoll').value.trim();

            // 3. Request Geolocation
            navigator.geolocation.getCurrentPosition(
                (pos) => sendData(name, rollNo, pos.coords.latitude, pos.coords.longitude),
                (err) => handleError("GPS Access Denied! Please enable location and try again.")
            );
        });

        // 4. Send data to Backend
        async function sendData(name, rollNo, lat, lng) {
            try {
                const response = await fetch('http://localhost:3000/submit-attendance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, rollNo, userId, lat, lng })
                });

                const result = await response.json();
                
                showStatus(result.message, response.ok);
            } catch (error) {
                handleError("Server is offline. Contact Teacher.");
            }
        }

        function showStatus(message, isSuccess) {
            msgBox.classList.remove('hidden');
            msgText.innerText = message;
            
            if(isSuccess) {
                msgBox.className = "mt-6 p-4 rounded-2xl text-center font-bold border-emerald-100 bg-emerald-50 text-emerald-700";
                form.classList.add('hidden'); // Hide form after success
            } else {
                msgBox.className = "mt-6 p-4 rounded-2xl text-center font-bold border-red-100 bg-red-50 text-red-700";
                submitBtn.innerText = "Retry Submission";
                submitBtn.disabled = false;
            }
        }

        function handleError(errorText) {
            showStatus(errorText, false);
        }
    </script>
</body>
</html>